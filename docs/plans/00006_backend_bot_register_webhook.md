# Task #00006: Telegram Webhook Infrastructure Setup

## 1. Концепция
Создание инструментария для управления связью между бэкендом и Telegram API. 
Архитектура должна обеспечивать безопасную смену URL (например, при переезде с dev на prod), возможность временного отключения вебхука и мониторинг состояния доставки сообщений.

## 2. Параметры конфигурации (.env)
Для работы вебхука в каждом окружении должны быть определены:
- `TELEGRAM_BOT_TOKEN`: Уникальный токен от BotFather.
- `APP_URL`: Базовый URL бэкенда (должен быть HTTPS).
- `TELEGRAM_SECRET_TOKEN`: Случайная строка для проверки, что запрос пришел именно от Telegram (заголовок `X-Telegram-Bot-Api-Secret-Token`).

## 3. Консольная команда установки

## 3.1. Установка / Обновление (`bot:webhook:set`)
Используется для первичной настройки или изменения адреса бэкенда.
* **Логика**: Повторный вызов `setWebhook` с новым URL автоматически перезаписывает старые настройки в Telegram.
* **Параметры**:
    - `--drop-pending-updates`: Флаг для очистки очереди сообщений, накопившихся на серверах Telegram. Критически важен при деплое на "боевой" сервер, чтобы игнорировать тестовый мусор.
* **Безопасность**: При установке передается `secret_token` (X-Telegram-Bot-Api-Secret-Token).

## 3.2. Удаление (`bot:webhook:delete`)
Используется для деактивации вебхука. 
* **Применение**: Перевод бота в режим Long Polling для локальной отладки или временная остановка обслуживания.
* **Действие**: Вызывает метод API `deleteWebhook`.

## 2.3. Инспекция (`bot:webhook:info`)
Выводит текущее состояние вебхука из Telegram API.
* **Ключевые показатели**:
    - `url`: Текущий адрес бэкенда.
    - `pending_update_count`: Количество сообщений, ожидающих обработки.
    - `last_error_date` / `last_error_message`: Диагностика проблем с SSL или доступностью сервера.

### Логика работы:
1. Формирует URL: `https://{APP_URL}/webhook/telegram`.
2. Отправляет запрос к Telegram API: `https://api.telegram.org/bot{TOKEN}/setWebhook`.
3. Передает параметры:
    - `url`: адрес нашего эндпоинта.
    - `secret_token`: значение из конфига для защиты.
    - `allowed_updates`: `["message", "callback_query", "my_chat_member"]`.
    - `drop_pending_updates`: `true` (чтобы избежать очереди старых сообщений при смене логики).

## 4. План реализации

### Шаг 1: Сервис управления
Реализация `WebhookService` (на базе Symfony HttpClient).
- Метод `setup()` (с логикой формирования URL и передачи секрета).
- Метод `remove()`.
- Метод `getStatus()`.

**Важное замечание** - Необходмио предусмотреть единую абстракцию для настройки взаимодействия с ботом, 
чтобы в дальнейшем можно было добавить интеграцию с новым мессенджером (Whatsapp и тп), конкретная реализация для конкретного 
мессенджера должна находиться в инфраструктурном слое в адаптере. 

### Шаг 2: Консольные команды
Реализация консольных команд для методов указанных выше.

### Шаг 3: Контроллер (EntryPoint)
Создание `WebhookController`:
- Принимает `POST` запрос.
- Выполняет валидацию секрета.
- Передает Payload в Nutgram.
- Возвращает `HTTP 200 OK` (обязательно пустой ответ или пустой JSON).

#### Алгоритм обработки:
1. **Security Check**: Middleware проверяет заголовок `X-Telegram-Bot-Api-Secret-Token`. Если он не совпадает с локальным — возвращается `403 Forbidden`.
2. **Fast Response**: Сервер должен вернуть `200 OK` до начала выполнения тяжелых задач (регистрация в Account, запросы в Billing), чтобы Telegram

### Шаг 3: Документация
Обновить Readme.md с описанием ключевых моментов для дальнейшей разработки.

## 5. Definition of Done
- [ ] Бот успешно переключается между разными `APP_URL` без ручной правки БД.
- [ ] Очередь обновлений может быть принудительно очищена при установке.
- [ ] Команда `bot:webhook:info` показывает `ok: true` и корректный URL.
- [ ] Прямые запросы к вебхуку без корректного заголовка завершаются ошибкой 403.