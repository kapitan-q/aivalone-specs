# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞

## –¶–µ–ª—å
–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É Domain —Å–ª–æ—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–≥ –±—ã—Ç—å –≤—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.

---

## –ó–∞–¥–∞—á–∞ 1: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å BillingPort (–ö—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** `BillingConversation` —Ç—Ä–µ–±—É–µ—Ç `BillingPortInterface`, –Ω–æ –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.

**–§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:**
- `services/aivalone-backend/src/Context/Bot/Infrastructure/Billing/BillingPort.php`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `BillingPort implements BillingPortInterface`
2. –í–Ω–µ–¥—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `Billing\Application\Service\SubscriptionService`
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã:
   - `getCurrentPlan()` - –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏ —Ç–∞—Ä–∏—Ñ
   - `getAvailablePlans()` - —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ —á–µ—Ä–µ–∑ `TariffPlanRepository`
   - `generatePaymentLink()` - –∑–∞–≥–ª—É—à–∫–∞ (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π)
   - `checkPaymentStatus()` - –∑–∞–≥–ª—É—à–∫–∞
   - `getPaymentHistory()` - —á–µ—Ä–µ–∑ SubscriptionRepository

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```php
namespace App\Context\Bot\Infrastructure\Billing;

use App\Context\Billing\Application\Service\SubscriptionService;
use App\Context\Billing\Domain\Repository\TariffPlanRepositoryInterface;
use App\Context\Bot\Application\Port\Account\BillingPortInterface;
use App\Context\Shared\Domain\ValueObject\UserId;

class BillingPort implements BillingPortInterface
{
    public function __construct(
        private SubscriptionService $subscriptionService,
        private TariffPlanRepositoryInterface $tariffPlanRepository
    ) {}

    public function getCurrentPlan(UserId $userId): array
    {
        // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
}
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ services.yaml:**
```yaml
App\Context\Bot\Application\Port\Account\BillingPortInterface:
    alias: App\Context\Bot\Infrastructure\Billing\BillingPort
```

---

## –ó–∞–¥–∞—á–∞ 2: –£–±—Ä–∞—Ç—å –∏–º–ø–æ—Ä—Ç FilterStrategy –∏–∑ Bot –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞:** `SetupFilterConversation` –Ω–∞–ø—Ä—è–º—É—é –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `Monitoring\Domain\ValueObject\FilterStrategy`

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `services/aivalone-backend/src/Context/Bot/Application/Conversation/SetupFilterConversation.php`
- `services/aivalone-backend/src/Context/Bot/Application/Port/Monitoring/DTO/FilterDTO.php`

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–†–∞—Å—à–∏—Ä–∏—Ç—å FilterDTO** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getStrategyLabel()`:
```php
// FilterDTO.php
public function getStrategyLabel(): string
{
    return match($this->strategy) {
        'simple' => '–ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫',
        'morpho' => '–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫',
        'ai' => 'AI –ø–æ–∏—Å–∫',
        default => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
}
```

2. **–ò–∑–º–µ–Ω–∏—Ç—å SetupFilterConversation** - —É–±—Ä–∞—Ç—å import FilterStrategy:
```php
// –ë—ã–ª–æ:
use App\Context\Monitoring\Domain\ValueObject\FilterStrategy;
$enum = FilterStrategy::tryFrom($strategy);
return $enum?->getLabel() ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

// –°—Ç–∞–ª–æ:
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–æ–¥—ã –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ –ø–æ—Ä—Ç–∞
private function getStrategyLabel(string $strategy): string
{
    return match($strategy) {
        'simple' => '–ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫',
        'morpho' => '–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫',
        'ai' => 'AI –ø–æ–∏—Å–∫',
        default => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
}
```

3. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getAvailableStrategies()` –≤ `FiltersPortInterface`:
```php
// FiltersPortInterface.php
public function getAvailableStrategies(): array;
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: [['code' => 'simple', 'label' => '–ü—Ä–æ—Å—Ç–æ–π', 'premium' => false], ...]
```

---

## –ó–∞–¥–∞—á–∞ 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ MonitoringFiltersPort (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–¥–∞–ø—Ç–µ—Ä —Å–æ–∑–¥–∞–µ—Ç `Filter` –æ–±—ä–µ–∫—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `FilterRepository`.

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `services/aivalone-backend/src/Context/Bot/Infrastructure/Monitoring/MonitoringFiltersPort.php`
- `services/aivalone-backend/src/Context/Monitoring/Application/Command/CreateOrUpdateFilterCommand.php` (—Å–æ–∑–¥–∞—Ç—å)
- `services/aivalone-backend/src/Context/Monitoring/Application/CommandHandler/CreateOrUpdateFilterHandler.php` (—Å–æ–∑–¥–∞—Ç—å)

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ Monitoring –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:**
```php
// Monitoring/Application/Command/CreateOrUpdateFilterCommand.php
namespace App\Context\Monitoring\Application\Command;

class CreateOrUpdateFilterCommand
{
    public function __construct(
        public readonly string $id,
        public readonly string $name,
        public readonly string $ownerId,
        public readonly int $chatId,
        public readonly array $keywords,
        public readonly string $strategy,
        public readonly bool $enabled = true
    ) {}
}
```

2. **–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:**
```php
// Monitoring/Application/CommandHandler/CreateOrUpdateFilterHandler.php
namespace App\Context\Monitoring\Application\CommandHandler;

use App\Context\Monitoring\Application\Command\CreateOrUpdateFilterCommand;
use App\Context\Monitoring\Domain\Model\Filter;
use App\Context\Monitoring\Domain\Repository\FilterRepositoryInterface;
use Symfony\Component\Messenger\Attribute\AsMessageHandler;

#[AsMessageHandler]
class CreateOrUpdateFilterHandler
{
    public function __construct(
        private FilterRepositoryInterface $filterRepository
    ) {}

    public function __invoke(CreateOrUpdateFilterCommand $command): Filter
    {
        $filter = $this->filterRepository->findById($command->id);

        if ($filter === null) {
            $filter = new Filter(
                $command->id,
                $command->name,
                new UserId($command->ownerId),
                $command->chatId,
                $command->keywords,
                $command->enabled,
                $command->strategy
            );
        } else {
            $filter->updateName($command->name);
            $filter->updateKeywords($command->keywords);
            $filter->changeStrategy($command->strategy);
            $command->enabled ? $filter->enable() : $filter->disable();
        }

        $this->filterRepository->save($filter);
        return $filter;
    }
}
```

3. **–ò–∑–º–µ–Ω–∏—Ç—å MonitoringFiltersPort:**
```php
// MonitoringFiltersPort.php
public function upsert(...): FilterDTO
{
    $command = new CreateOrUpdateFilterCommand(
        $id, $name, $ownerId->getValue(), $chatId, $keywords, $strategy, $enabled
    );

    // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ HandleTrait –∏–ª–∏ QueryBus
    $filter = $this->commandBus->dispatch($command);

    return $this->toDto($filter);
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–ø—Ä–æ—â–µ):** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Application Service –≤–º–µ—Å—Ç–æ Command:
```php
// –°–æ–∑–¥–∞—Ç—å Monitoring/Application/Service/FilterService.php
// MonitoringFiltersPort –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å FilterService->upsert()
```

---

## –ó–∞–¥–∞—á–∞ 4: –ò—Å–ø—Ä–∞–≤–∏—Ç—å Monitoring ‚Üí Account –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞:** `Monitoring/Infrastructure/Account/AccountPort` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Account\Domain\Repository\UserRepositoryInterface`

**–§–∞–π–ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `services/aivalone-backend/src/Context/Monitoring/Infrastructure/Account/AccountPort.php`

**–î–µ–π—Å—Ç–≤–∏—è:**

1. **–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –Ω–∞ Application Service:**
```php
// –ë—ã–ª–æ:
use App\Context\Account\Domain\Repository\UserRepositoryInterface;

public function __construct(
    private UserRepositoryInterface $userRepository,
    private FeatureRegistry $featureRegistry
) {}

// –°—Ç–∞–ª–æ:
use App\Context\Account\Application\Service\UserService;

public function __construct(
    private UserService $userService,
    private FeatureRegistry $featureRegistry
) {}

public function canUseStrategy(UserId $userId, string $strategy): bool
{
    $user = $this->userService->getUserById($userId);
    if ($user === null) {
        return false;
    }

    $permissionCode = match($strategy) {
        'morpho' => 'CAN_USE_MORPHOLOGY',
        'ai' => 'CAN_USE_AI',
        default => null
    };

    if ($permissionCode === null) {
        return true; // simple –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º
    }

    return $user->can($permissionCode, true, $this->featureRegistry);
}
```

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
|---|--------|-----------|-------------|
| 1 | BillingPort —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | –ù–µ—Ç |
| 2 | –£–±—Ä–∞—Ç—å FilterStrategy import | üî¥ –í—ã—Å–æ–∫–∏–π | –ù–µ—Ç |
| 3 | MonitoringFiltersPort —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã | üü° –°—Ä–µ–¥–Ω–∏–π | –ó–∞–¥–∞—á–∞ 2 |
| 4 | Monitoring‚ÜíAccount —á–µ—Ä–µ–∑ Service | üü° –°—Ä–µ–¥–Ω–∏–π | –ù–µ—Ç |

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ Domain –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏
grep -r "use App\\\\Context\\\\Monitoring\\\\Domain" services/aivalone-backend/src/Context/Bot/Application/
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
cd services/aivalone-backend && ./vendor/bin/phpunit

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω PHPStan)
./vendor/bin/phpstan analyse
```

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:
- –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Ports/Adapters –∏ Events/Commands
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤—ã–Ω–æ—Å—É –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
