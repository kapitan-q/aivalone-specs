# UpdateUserTariffs Process Specification

## Назначение

Процесс **обновления тарифов пользователя** в системе Aivalone.  
Отвечает за корректное изменение активных тарифных планов пользователя, проверку бизнес-инвариантов и публикацию события об изменении.

## Предусловия

* Пользователь должен существовать в системе (идентифицируется по `UserId`).  
* Новый список тарифов должен быть валидным (например, содержать только доступные коды тарифов).  
* Все изменения тарифов должны фиксировать дату последнего изменения (`updatedAt`).

## Поток выполнения

1. **Валидация данных**
   * Проверка наличия `UserId`.
   * Проверка существования пользователя по `UserId`.
   * Проверка корректности нового списка тарифов (например, все тарифы существуют в системе).

2. **Обновление тарифов пользователя**
   * Вызов `User::replaceTariffPlans` для замены текущих тарифов пользователя на новые.

3. **Сохранение пользователя**
   * Сохранение агрегата `User` через `UserRepository::save(User)`.

4. **Публикация событий**
   * Публикация накопленных событий доменной модели

## Исключения / Ошибки

* Пользователь не найден — выбрасывается [UserNotFoundException](../exceptions/user-not-found-exception.md).
* Некорректные тарифы — выбрасывается [ValidationException](../../shared/exceptions/validation-exception.md).

## Связанные документы

* [Процессы](./overview.md)
* [User](../model/user.md)  
* [UserService](../services/user-service.md)