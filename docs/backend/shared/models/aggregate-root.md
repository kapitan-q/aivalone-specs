# AggregateRoot Base Specification

## Назначение

`AggregateRoot` — базовый абстрактный класс **Domain Layer**, предназначенный для всех агрегатов в системе Aivalone.

Он решает две ключевые задачи:

1. Явно обозначает границу агрегата (DDD)
2. Обеспечивает **накопление и публикацию доменных событий**

`AggregateRoot` **не знает**, кто и как будет публиковать события (EventBus, Message Broker и т.д.).
Он лишь накапливает их — публикация происходит на уровне Application Layer.

## Роль в архитектуре

`AggregateRoot` используется как:

* базовый класс для доменных агрегатов
* источник доменных событий
* механизм связи **Domain → Application Layer**

Схема:

Domain Model (AggregateRoot)
|
| (накапливает DomainEvents)
v
Application Service
|
| (публикует)
v
EventBus


## Основные обязанности 

* хранить доменные события (реализации [DomainEventInterface](../events/domain-event-interface.md))
* позволять добавлять события из доменной логики
* отдавать накопленные события для публикации
* гарантировать неизменяемость уже опубликованных событий

## Контракт AggregateRoot

### Хранимые данные

* `recordedEvents` — список доменных событий, возникших в агрегате

События:

* добавляются только внутри агрегата
* недоступны для прямой модификации извне

### Основные методы

#### recordEvent(DomainEventInterface $event): void

Регистрирует доменное событие внутри агрегата.

Используется:

* внутри методов агрегата
* после успешного изменения инвариантов


#### pullEvents(): array

Возвращает **все накопленные события** и **очищает внутреннее хранилище**.

Используется:

* Application Service
* Command Handler

Гарантии:

* каждое событие может быть опубликовано только один раз
* после вызова массив событий внутри агрегата пуст

#### hasEvents(): bool

Проверяет, есть ли у агрегата непубликованные события.

Используется для:

* оптимизаций
* отладки
* тестирования

## Жизненный цикл событий

1. Агрегат изменяет состояние
2. Агрегат вызывает `recordEvent(...)`
3. Application Service сохраняет агрегат
4. Application Service вызывает `pullEvents()`
5. События публикуются в EventBus

## Чего AggregateRoot НЕ делает

* не публикует события сам
* не зависит от EventBus
* не знает про инфраструктуру
* не выполняет use-case / orchestration

## Инварианты

* Доменные события всегда соответствуют реальному изменению состояния
* Событие не может быть добавлено без изменения агрегата
* События immutable
* События очищаются только через `pullEvents()`


## Архитектурные замечания

* Относится к моделям доменного уровня (Domain Model)
* Абстрактный класс
* Подходит для Event-Driven и CQRS архитектур

## Связанные документы

* [Shared Context Overview](../overview.md)
* [Models](./overview.md)

## Статус

* [] Реализован базовый `AggregateRoot`
* [] Реализовано накопление событий
* [] Реализован метод `pullEvents`
* [] Добавлены unit-тесты


