# –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

## –û–±–∑–æ—Ä

–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏ –∏ —à–∞–≥–∞–º–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (—Ç–µ–∫—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ inline-–∫–Ω–æ–ø–∫–∞) –∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ (Telegram, WhatsApp, Viber –∏ –¥—Ä.).

## –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã

```
/conversationCode[:step[:param1[:param2[:...:paramN]]]]
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|----------|---------|
| `/` | –ü—Ä–µ—Ñ–∏–∫—Å –∫–æ–º–∞–Ω–¥—ã | `/` |
| `conversationCode` | –ö–æ–¥ –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) | `billing`, `setupfilter`, `menu` |
| `step` | –ò–º—è —à–∞–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | `stepSelect`, `stepPayment` |
| `param1..N` | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) | `premium`, `uuid-123` |

### –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å

–î–≤–æ–µ—Ç–æ—á–∏–µ (`:`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

## –ü—Ä–∏–º–µ—Ä—ã

### –ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–∞

```
/billing           ‚Üí –ó–∞–ø—É—Å–∫ BillingConversation —Å stepStart
/menu              ‚Üí –ó–∞–ø—É—Å–∫ MenuConversation
/setupfilter       ‚Üí –ó–∞–ø—É—Å–∫ SetupFilterConversation
```

### –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É

```
/billing:stepSelect         ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É —Ç–∞—Ä–∏—Ñ–∞
/billing:stepHistory        ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
/setupfilter:stepName       ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤–≤–æ–¥—É –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
```

### –®–∞–≥ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```
/billing:stepPayment:premium        ‚Üí –û–ø–ª–∞—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ "premium"
/billing:stepPayment:basic:monthly  ‚Üí –û–ø–ª–∞—Ç–∞ "basic" —Å –ø–µ—Ä–∏–æ–¥–æ–º "monthly"
/setupfilter:stepEdit:uuid-123-456  ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å ID
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö

–ú–µ—Ç–æ–¥—ã `AbstractConversation` –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥:

```php
// –í–Ω—É—Ç—Ä–∏ BillingConversation

// –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É
$this->getLink('stepSelect')           // ‚Üí '/billing:stepSelect'

// –®–∞–≥ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
$this->getLink('stepPayment', ['premium'])  // ‚Üí '/billing:stepPayment:premium'

// –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
$this->getLink('stepPayment', ['premium', 'monthly'])  // ‚Üí '/billing:stepPayment:premium:monthly'

// –ü–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é
$this->getMenuLink()                   // ‚Üí '/menu'

// –û—Ç–º–µ–Ω–∞ (–≤–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—É –¥–∏–∞–ª–æ–≥–∞)
$this->getCancelLink()                 // ‚Üí '/billing'
```

### –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```php
$keyboard = [
    [
        ['text' => 'üíé Premium', 'callback_data' => $this->getLink('stepPayment', ['premium'])],
        ['text' => 'ü•á Basic', 'callback_data' => $this->getLink('stepPayment', ['basic'])],
    ],
    [
        ['text' => 'üîô –ù–∞–∑–∞–¥', 'callback_data' => $this->getCancelLink()],
        ['text' => 'üè† –ú–µ–Ω—é', 'callback_data' => $this->getMenuLink()],
    ],
];
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ —à–∞–≥–µ

```php
public function stepPayment(BotRequest $request): BotResponse
{
    $plan = $request->getParam(0);            // 'premium'
    $period = $request->getParam(1, 'yearly'); // 'monthly' –∏–ª–∏ 'yearly' (–¥–µ—Ñ–æ–ª—Ç)

    // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ $plan —Å –ø–µ—Ä–∏–æ–¥–æ–º $period
}

public function stepEdit(BotRequest $request): BotResponse
{
    $filterId = $request->getParam(0);

    if ($filterId === null) {
        return new BotResponse('ID —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
}
```

## –ü–∞—Ä—Å–∏–Ω–≥ –≤ TelegramAdapter

`TelegramAdapter` –ø–∞—Ä—Å–∏—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑:
- –¢–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å `/`
- Callback data –æ—Ç inline-–∫–Ω–æ–ø–æ–∫

```php
private function parseCommandFormat(string $data): array
{
    $data = ltrim($data, '/');

    if (empty($data)) {
        return ['command' => null, 'step' => null, 'params' => []];
    }

    $parts = explode(':', $data);

    return [
        'command' => $parts[0] ?? null,
        'step' => $parts[1] ?? null,
        'params' => array_slice($parts, 2),
    ];
}
```

## BotRequest

–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `BotRequest`:

```php
$request->getCommand()       // 'billing'
$request->getStep()          // 'stepPayment'
$request->getParams()        // ['premium', 'monthly']
$request->getParam(0)        // 'premium'
$request->getParam(1)        // 'monthly'
$request->getParam(2, 'def') // 'def' (–¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
$request->isNavigation()     // true (–µ—Å–ª–∏ –µ—Å—Ç—å command –∏–ª–∏ step)
```

## –õ–æ–≥–∏–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞

### –¢–æ–ª—å–∫–æ command (–±–µ–∑ step)

```
/billing ‚Üí –°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∑–∞–ø—É—Å–∫ stepStart
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ó–∞–ø—É—Å–∫–∞ –¥–∏–∞–ª–æ–≥–∞ —Å –Ω–∞—á–∞–ª–∞
- –ö–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞" (–≤–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—É)

### command + step

```
/billing:stepSelect ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ stepSelect –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ
```

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å command ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ step
2. –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí —Å–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∑–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ step

### –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ command)

–¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞.

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

### –ë—ã–ª–æ (Telegram-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)

```php
// –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã callback_data
'action:cancel'
'action:change'
'plan:premium'
'strategy:morpho'
'menu'
```

### –°—Ç–∞–ª–æ (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)

```php
// –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö
$this->getCancelLink()              // '/billing' –≤–º–µ—Å—Ç–æ 'action:cancel'
$this->getLink('stepSelect')        // '/billing:stepSelect' –≤–º–µ—Å—Ç–æ 'action:change'
$this->getLink('stepPayment', ['premium'])  // '/billing:stepPayment:premium' –≤–º–µ—Å—Ç–æ 'plan:premium'
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –î–ª–∏–Ω–∞ callback_data

Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç callback_data –¥–æ 64 –±–∞–π—Ç. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞.

### –°–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö

–î–≤–æ–µ—Ç–æ—á–∏–µ (`:`) –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å. –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–≤–æ–µ—Ç–æ—á–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL-encoding –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –í—Å–µ –¥–∏–∞–ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–î–∏–∞–ª–æ–≥–∏](conversations.md) ‚Äî —Å–∏—Å—Ç–µ–º–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –º–µ—Ç–æ–¥—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- [–†–æ—É—Ç–∏–Ω–≥](router.md) ‚Äî –ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥
- [–û–±–∑–æ—Ä Bot Context](overview.md) ‚Äî –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
