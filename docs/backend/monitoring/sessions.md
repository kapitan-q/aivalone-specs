# Сессии

## Обзор

Сессии Telegram используются для прослушивания сообщений из групп. Система поддерживает два типа сессий: системные (для публичных групп) и пользовательские (для приватных групп).

## Типы сессий

### SystemSession (Системная)

**Назначение:** Прослушивание публичных групп.

**Особенности:**
- Группы распределяются равномерно между сервисными аккаунтами
- При добавлении новой публичной группы выбирается сессия с наименьшей нагрузкой
- Если группа отсутствует в подписках сервисного аккаунта, отправляется команда на автоматическое присоединение (Join)

**Балансировка:**
- Используется `SystemSessionBalancer` для выбора сессии с минимальной нагрузкой
- Счетчик нагрузки (`loadCounter`) увеличивается при добавлении группы

### UserSession (Пользовательская)

**Назначение:** Прослушивание приватных групп конкретного пользователя.

**Особенности:**
- Индивидуальная сессия пользователя
- Используется для групп, доступных только конкретному пользователю
- Создается через диалог `AuthConversation`

## Доменная модель

### Session

**Поля:**
- `id` - Уникальный идентификатор
- `type` - Тип сессии (system/user)
- `ownerId` - Владелец (для user сессий, nullable для system)
- `apiHash` - API hash Telegram
- `sessionString` - Строка сессии (зашифрована)
- `isActive` - Активна ли сессия
- `loadCounter` - Счетчик нагрузки (для балансировки)
- `createdAt` - Дата создания
- `updatedAt` - Дата обновления

## Управление сессиями

### Создание системной сессии

Создается администратором через консольную команду или DataFixtures.

**Пример:**
```php
$session = new Session(
    type: SessionType::SYSTEM,
    apiHash: $apiHash,
    sessionString: $sessionString
);
$sessionRepository->save($session);
```

### Создание пользовательской сессии

Создается через диалог `AuthConversation` в Bot Context.

**Процесс:**
1. Пользователь отправляет номер телефона
2. Пользователь отправляет код подтверждения
3. Пользователь отправляет пароль 2FA (если установлен)
4. Сессия сохраняется в БД (зашифрована)

## GroupConnection

Связка сессии с группой.

**Поля:**
- `id` - Уникальный идентификатор
- `sessionId` - ID сессии
- `chatId` - ID чата
- `status` - Статус (active/broken/left)

**Статусы:**
- `active` - Активное подключение, сессия имеет доступ к группе
- `broken` - Потеря доступа (пользователь покинул группу, отозвал доступ)
- `left` - Сессия покинула группу

## Балансировка системных сессий

### SystemSessionBalancer

Сервис для балансировки нагрузки между системными сессиями.

**Алгоритм:**

1. Получает все активные системные сессии (`type = system`, `isActive = true`)
2. Сортирует их по `loadCounter` (по возрастанию)
3. Выбирает сессию с минимальной нагрузкой
4. Увеличивает `loadCounter` выбранной сессии
5. Создает `GroupConnection` с выбранной сессией

**Пример:**
```php
$balancer = $this->systemSessionBalancer;
$session = $balancer->selectSessionForChat($chatId);
$connection = new GroupConnection($session->getId(), $chatId);
$connectionRepository->save($connection);
```

## Failover (Переключение при сбое)

### Логика пересчета при сбое

1. **Сигнал о потере доступа:**
   - При получении `AccessLostEvent` от Python-bridge
   - Помечает `GroupConnection` как `broken`

2. **Поиск альтернативной сессии:**
   - Ищет в карте пересечений следующую доступную сессию (сервисную или другого пользователя)
   - Если сессия найдена - отправляет команду в Python на переключение источника прослушивания

3. **Уведомление пользователя:**
   - Пользователь, которому принадлежала сессия, перестает получать сообщения из данной группы
   - Пользователь уведомляется об этом

4. **Остановка мониторинга:**
   - Если сессий больше нет - мониторинг группы останавливается
   - Все пользователи, мониторящие эту группу, уведомляются

### Деактивация пользователя

При выходе пользователя или отзыве авторизации:

1. Все связанные с ним `GroupConnection` аннулируются
2. Выполняется пересчет для всех затронутых групп
3. Группы переключаются на другие сессии или останавливается прослушивание

## Join Queue

Очередь присоединения к группам для системных сессий.

### JoinQueueService

**Функции:**
- Реализует антифрод-защиту с задержками между join-ами
- Экспоненциальный backoff при большом количестве запросов

**Алгоритм:**

1. При добавлении новой публичной группы:
   - Если ни один сервисный аккаунт не имеет доступа к этой группе
   - Задача ставится в Join Queue

2. Обработка очереди:
   - Выбирается системная сессия с минимальной нагрузкой
   - Отправляется команда `JoinChatCommand` в Python-bridge
   - После успешного присоединения создается `GroupConnection`

3. Защита от бана:
   - Задержки между join-ами (например, 5-10 минут)
   - Экспоненциальный backoff при ошибках

## Интеграция с Python-bridge

### Команды в Python-bridge

- `StartMonitoringChatCommand` - Начать мониторинг чата
  - `chatId` - ID чата
  - `sessionData` - Данные сессии (apiHash, sessionString)
  
- `StopMonitoringChatCommand` - Остановить мониторинг
  - `chatId` - ID чата
  
- `JoinChatCommand` - Присоединиться к чату
  - `chatId` - ID чата
  - `sessionData` - Данные сессии
  
- `SwitchMonitoringSourceCommand` - Переключить источник мониторинга
  - `chatId` - ID чата
  - `oldSessionData` - Старые данные сессии
  - `newSessionData` - Новые данные сессии

### События от Python-bridge

- `AccessLostEvent` - Потеря доступа к чату
  - `chatId` - ID чата
  - `sessionId` - ID сессии

## База данных

Таблица `monitoring_sessions`:
- `id` (PK) - Уникальный идентификатор
- `type` - Тип сессии (system/user)
- `owner_id` (FK, nullable) - ID владельца
- `api_hash` - API hash Telegram
- `session_string` (encrypted) - Строка сессии (зашифрована)
- `is_active` - Активна ли сессия
- `load_counter` - Счетчик нагрузки
- `created_at` - Дата создания
- `updated_at` - Дата обновления

Таблица `monitoring_group_connections`:
- `id` (PK) - Уникальный идентификатор
- `session_id` (FK) - ID сессии
- `chat_id` - ID чата
- `status` - Статус (active/broken/left)
- `created_at` - Дата создания
- `updated_at` - Дата обновления

**Индексы:**
- `idx_session_id` - Для быстрого поиска подключений сессии
- `idx_chat_id` - Для быстрого поиска подключений чата
- `idx_status` - Для быстрого поиска по статусу

## Связанные документы

- [Обзор Monitoring Context](overview.md)
- [Фильтры](filters.md)
- [Карта пересечений](intersection-map.md)
- [Bot Context - AuthConversation](../bot/conversations.md)
