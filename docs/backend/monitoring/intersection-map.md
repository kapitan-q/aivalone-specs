# Карта пересечений (Intersection Map)

## Обзор

Карта пересечений реализует модель **Shared Ingress**: одна группа прослушивается одной оптимальной сессией, даже если на неё подписано множество пользователей. Это минимизирует использование ресурсов и обеспечивает эффективное распределение нагрузки.

## Принцип работы

### Единая подписка

Если на одну группу подписаны несколько пользователей:
- Python-сервис получает команду на прослушивание через **одну** выбранную сессию из пула доступных
- Все пользователи получают уведомления из одного источника
- При совпадении фильтра сообщение отправляется всем подписанным пользователям

### Выбор сессии

**Для публичных групп:**
- Выбирается системная сессия с минимальной нагрузкой через `SystemSessionBalancer`
- Если группа отсутствует в подписках сервисного аккаунта - отправляется команда на автоматическое присоединение (Join)

**Для приватных групп:**
- Используется пользовательская сессия владельца фильтра
- Если у пользователя нет активной сессии - требуется авторизация через `AuthConversation`

## IntersectionMapService

Сервис для управления картой пересечений.

### Выбор primary сессии

**Алгоритм:**

1. Получает все активные фильтры для чата
2. Определяет тип группы (публичная/приватная):
   - Если есть хотя бы один фильтр с пользовательской сессией - группа считается приватной
   - Иначе - публичной

3. Для публичной группы:
   - Выбирает системную сессию через `SystemSessionBalancer`
   - Если сессия не имеет доступа к группе - ставит задачу в Join Queue

4. Для приватной группы:
   - Выбирает пользовательскую сессию владельца первого фильтра
   - Если сессия не активна - требует авторизации

5. Создает или обновляет `GroupConnection` с выбранной сессией

### Backup pool сессий

Для обеспечения отказоустойчивости система поддерживает пул резервных сессий:

1. **Primary сессия** - основная сессия для прослушивания
2. **Backup сессии** - резервные сессии на случай сбоя

**Логика:**
- При потере доступа primary сессии автоматически переключается на backup
- Если backup сессий нет - мониторинг останавливается

## Failover (Переключение при сбое)

### Логика пересчета при сбое

1. **Сигнал о потере доступа:**
   - При получении `AccessLostEvent` от Python-bridge
   - Помечает `GroupConnection` как `broken`

2. **Поиск альтернативной сессии:**
   - Ищет в карте пересечений следующую доступную сессию:
     - Для публичной группы: другую системную сессию
     - Для приватной группы: другую пользовательскую сессию, имеющую доступ к группе
   - Если сессия найдена - отправляет команду `SwitchMonitoringSourceCommand` в Python-bridge

3. **Уведомление пользователей:**
   - Пользователь, которому принадлежала сессия, перестает получать сообщения из данной группы
   - Пользователь уведомляется об этом через Bot Context

4. **Остановка мониторинга:**
   - Если сессий больше нет - мониторинг группы останавливается
   - Все пользователи, мониторящие эту группу, уведомляются

### Деактивация пользователя

При выходе пользователя или отзыве авторизации:

1. Все связанные с ним `GroupConnection` аннулируются
2. Выполняется пересчет для всех затронутых групп через `IntersectionMapService`
3. Группы переключаются на другие сессии или останавливается прослушивание

## Примеры работы

### Пример 1: Публичная группа

**Сценарий:**
- Пользователь A создает фильтр для публичной группы `@php_jobs`
- Пользователь B создает фильтр для той же группы

**Результат:**
- Выбирается одна системная сессия (например, Session #1)
- Создается один `GroupConnection` для группы `@php_jobs` с Session #1
- Python-сервис получает одну команду на прослушивание
- При совпадении фильтра оба пользователя получают уведомления

### Пример 2: Приватная группа

**Сценарий:**
- Пользователь A создает фильтр для приватной группы (требуется его сессия)
- Пользователь B пытается создать фильтр для той же группы

**Результат:**
- Используется сессия пользователя A
- Если пользователь B имеет доступ к группе через свою сессию - может быть создан backup
- При потере доступа сессии A - переключение на сессию B (если доступна)

### Пример 3: Failover

**Сценарий:**
- Группа прослушивается через Session #1
- Получен `AccessLostEvent` для Session #1

**Результат:**
- `GroupConnection` помечается как `broken`
- Ищется альтернативная сессия (например, Session #2)
- Отправляется `SwitchMonitoringSourceCommand` в Python-bridge
- Мониторинг продолжается через Session #2
- Пользователи уведомляются о переключении

## Интеграция с другими компонентами

### SystemSessionBalancer

Используется для выбора системной сессии с минимальной нагрузкой.

**Интеграция:**
```php
$session = $this->systemSessionBalancer->selectSessionForChat($chatId);
```

### JoinQueueService

Используется для постановки задач на присоединение к группам.

**Интеграция:**
```php
if (!$this->hasAccessToChat($session, $chatId)) {
    $this->joinQueueService->enqueue($chatId, $session);
}
```

### BroadcastMatcher

Используется для сопоставления сообщений с фильтрами после получения из одной сессии.

**Интеграция:**
```php
$matchedFilters = $this->broadcastMatcher->match($message, $chatId);
foreach ($matchedFilters as $filter) {
    $this->sendNotification($filter->getOwnerId(), $message);
}
```

## Оптимизация

### Минимизация ресурсов

- Одна группа прослушивается одной сессией
- Множественные подписки не создают дополнительную нагрузку
- Эффективное использование системных сессий

### Отказоустойчивость

- Автоматическое переключение при сбое
- Резервные сессии для критичных групп
- Уведомления пользователей о проблемах

### Масштабируемость

- Равномерное распределение нагрузки между системными сессиями
- Возможность добавления новых системных сессий без изменения логики
- Поддержка множественных пользовательских сессий

## База данных

Карта пересечений реализуется через таблицу `monitoring_group_connections`:

- `session_id` - ID сессии (primary)
- `chat_id` - ID чата
- `status` - Статус подключения

**Индексы:**
- `idx_chat_id` - Для быстрого поиска сессии для чата
- `idx_session_id` - Для быстрого поиска чатов сессии

## Связанные документы

- [Обзор Monitoring Context](overview.md)
- [Фильтры](filters.md)
- [Сессии](sessions.md)
- [Bot Context](../bot/overview.md)
