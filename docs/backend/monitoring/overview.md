# Monitoring Context - Обзор

## Назначение

Контекст **Monitoring** отвечает за управление подписками пользователей на группы, хранение поисковых фильтров и сопоставление входящих сообщений с этими фильтрами.

## Основные функции

1. **Управление фильтрами**
   - Хранение фильтров пользователей с ключевыми словами
   - Поддержка различных стратегий сопоставления (Simple, Morpho, AI)

2. **Управление сессиями**
   - Хранение сессий Telegram (системных и пользовательских)
   - Балансировка нагрузки между системными сессиями
   - Failover при потере доступа к группе

3. **Карта пересечений (Intersection Map)**
   - Обеспечение прослушивания одной группы одной оптимальной сессией
   - Минимизация ресурсов при множественных подписках

4. **Сопоставление сообщений**
   - Обработка входящих сообщений из Telegram
   - Сопоставление с фильтрами пользователей
   - Отправка уведомлений при совпадении

## Архитектура

### Shared Ingress

Реализуется модель **Shared Ingress** на основе **Карты Пересечений (Intersection Map)**: одна группа прослушивается одной оптимальной сессией, даже если на неё подписано множество пользователей.

### Основной поток (Data Flow)

1. **Command:** Пользователь настраивает фильтр. Если группа новая — отправляется команда в Python-сервис на прослушивание `chat_id`
2. **Ingress:** Python-сервис транслирует сообщения из группы в шину (Message Broker)
3. **Processing:** Monitoring Context ловит сообщение, находит **все** активные фильтры для этой группы и выполняет сверку
4. **Egress:** При совпадении отправляется команда в **Bot Context** для уведомления пользователя с цитированием сообщения

## Доменные модели

### Filter

Фильтр мониторинга.

**Поля:**
- `id` - Уникальный идентификатор
- `ownerId` - Владелец фильтра (UserId)
- `name` - Название фильтра
- `chatId` - ID чата для мониторинга
- `keywords[]` - Массив ключевых слов
- `enabled` - Активен ли фильтр
- `strategy` - Стратегия сопоставления (simple/morpho/ai)

### Session

Сессия Telegram.

**Поля:**
- `id` - Уникальный идентификатор
- `type` - Тип сессии (system/user)
- `ownerId` - Владелец (для user сессий, nullable)
- `apiHash` - API hash Telegram
- `sessionString` - Строка сессии (зашифрована)
- `isActive` - Активна ли сессия
- `loadCounter` - Счетчик нагрузки (для балансировки)

**Типы:**
- `System` - Сервисная сессия для публичных групп
- `User` - Пользовательская сессия для приватных групп

### GroupConnection

Подключение группы к сессии.

**Поля:**
- `id` - Уникальный идентификатор
- `sessionId` - ID сессии
- `chatId` - ID чата
- `status` - Статус (active/broken/left)

**Статусы:**
- `active` - Активное подключение
- `broken` - Потеря доступа
- `left` - Покинута группа

## Сервисы приложения

### IntersectionMapService

Управление Shared Ingress и картой пересечений.

**Функции:**
- Выбирает primary и backup pool сессий для чата
- Реализует логику "одна группа слушается одной выбранной сессией"
- Поддерживает failover при потере доступа

### SystemSessionBalancer

Балансировка системных сессий.

**Функции:**
- Выбирает сессию с минимальной нагрузкой для публичных групп
- Управляет счетчиками нагрузки (`loadCounter`)

### BroadcastMatcher

Сопоставление сообщений с фильтрами.

**Функции:**
- Получает все активные фильтры для чата
- Применяет стратегию сопоставления (по умолчанию SimpleSubstringStrategy)
- Возвращает список совпавших фильтров

### JoinQueueService

Очередь присоединения к группам.

**Функции:**
- Реализует антифрод-защиту с задержками между join-ами
- Экспоненциальный backoff при большом количестве запросов

## Интеграция с Python-bridge

Взаимодействие происходит через RabbitMQ (AMQP) с JSON-контрактами.

### Команды в Python-bridge

- `StartMonitoringChatCommand` - Начать мониторинг чата
- `StopMonitoringChatCommand` - Остановить мониторинг
- `JoinChatCommand` - Присоединиться к чату (через Join Queue)
- `SwitchMonitoringSourceCommand` - Переключить источник мониторинга (failover)

### События от Python-bridge

- `IncomingTelegramMessageEvent` - Входящее сообщение из Telegram
- `AccessLostEvent` - Потеря доступа к чату

## Обработчики событий

### IncomingTelegramMessageHandler

Обрабатывает входящие сообщения от Python-bridge.

**Логика:**
1. Получает входящее сообщение
2. Находит совпавшие фильтры через `BroadcastMatcher`
3. Отправляет уведомления владельцам через `SendNotificationCommand`

### AccessLostEventHandler

Обрабатывает потерю доступа к чату.

**Логика:**
1. Помечает `GroupConnection` как `Broken`
2. Ищет альтернативную сессию через `IntersectionMapService`
3. Выполняет failover или останавливает мониторинг
4. Уведомляет пользователей

## Стратегии сопоставления

Реализованы через интерфейс `MatchStrategyInterface`:

1. **SimpleSubstringStrategy** (реализовано)
   - Простое вхождение подстроки (case-insensitive)
   - Поддержка UTF-8

2. **MorphoStrategy** (планируется)
   - Морфологический анализ (PHP)

3. **AIStrategy** (планируется)
   - Семантический анализ через AI Service

## База данных

Таблицы:
- `monitoring_filters` - Фильтры пользователей
- `monitoring_sessions` - Сессии Telegram
- `monitoring_group_connections` - Подключения групп к сессиям

## Связанные документы

- [Фильтры](filters.md)
- [Сессии](sessions.md)
- [Карта пересечений](intersection-map.md)
- [Bot Context](../bot/overview.md)
