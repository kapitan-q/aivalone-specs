# Billing Context - Обзор

## Назначение

Контекст **Billing** отвечает за управление тарифными планами, подписками пользователей и агрегацию прав доступа.

## Основные функции

1. **Управление тарифными планами**
   - Хранение тарифных планов (`TariffPlan`) и их опций (`TariffOption`)
   - Управление приоритетами тарифов для корректного слияния опций

2. **Управление подписками**
   - Создание и управление подписками пользователей (`Subscription`)
   - Поддержка нескольких одновременно активных подписок (наслаиваемые подписки)
   - Автоматическая деактивация истекающих подписок

3. **Агрегация прав**
   - Формирование итогового набора прав из всех активных подписок через `PermissionAggregator`
   - Публикация событий об изменении прав через Symfony Messenger

## Доменные модели

### TariffPlan

Тарифный план.

**Поля:**
- `id` - Уникальный идентификатор
- `name` - Название тарифа (например, "Premium")
- `code` - Код тарифа (например, `PREMIUM_MONTH`)
- `priority` - Приоритет тарифа (чем выше число, тем выше приоритет)
- `description` - Описание тарифа
- `price` - Цена (может быть `null` для бесплатного тарифа)

### TariffOption

Опция тарифа.

**Поля:**
- `id` - Уникальный идентификатор
- `name` - Название опции (например, "Лимит групп")
- `code` - Код опции (например, `MAX_GROUP`)
- `value` - Значение опции (например, `5`)

### TariffPlanOption

Связь между тарифным планом и опцией.

**Ограничения:**
- В связке `TariffPlan` <-> `TariffOption` код опции должен быть **уникальным**
- Один тариф не может иметь две разные опции с одним кодом

### Subscription

Подписка пользователя.

**Поля:**
- `id` - Уникальный идентификатор
- `userId` - ID пользователя
- `tariffPlanId` - ID тарифного плана
- `expiresAt` - Дата истечения подписки
- `isActive` - Активна ли подписка

**Принципы:**
- При покупке новой подписки создается новая запись (не заменяется существующая)
- Пользователь может иметь несколько одновременно активных подписок

## Сервисы приложения

### PermissionAggregator

Агрегирует права из всех активных подписок пользователя.

**Алгоритм:**
1. Выбирает все `Subscription` пользователя, где `expiresAt > now()`
2. Сортирует их по `TariffPlan.priority` (по убыванию)
3. Сливает `TariffOption` в единый массив (опции с высшим приоритетом перезаписывают низшие)
4. Генерирует событие `UserPermissionsUpdatedEvent` с итоговым JSON

### SubscriptionService

Управление подписками.

**Методы:**
- Создание новой подписки
- Деактивация подписки
- Проверка истечения срока

## События

### SubscriptionActivatedEvent

Выбрасывается при покупке новой подписки.

### SubscriptionExpiredEvent

Выбрасывается при истечении срока подписки.

### SubscriptionExpiringSoonEvent

Выбрасывается за 3 дня до истечения подписки (настраивается, может быть несколько периодов: 7-3-1 день).

**Особенность:** Событие отправляется один раз за указанный период, а не при каждом вызове метода проверки.

### UserPermissionsUpdatedEvent

Выбрасывается при изменении подписки (истечение срока, добавление новой, деактивация, удаление).

**Payload:**
- `userId` - ID пользователя
- `permissions` - JSON с итоговым набором прав

## Консольные команды

### app:billing:check-expiration

Проверяет истечение подписок и отправляет уведомления.

**Логика:**
- Запускается по расписанию (рекомендуется: раз в час)
- Находит подписки, срок которых истек
- Вызывает метод подписки `checkExpirationTime()`, который:
  - Выбрасывает `SubscriptionExpiredEvent` - если срок подписки истек
  - Выбрасывает `SubscriptionExpiringSoonEvent` - за 3 дня до истечения (один раз за период)
- Автоматически пересчитывает права пользователей

## API Endpoints

### GET /api/billing/tariffs

Получение списка тарифных планов с опциями.

**Ответ:**
```json
{
  "tariffs": [
    {
      "id": 1,
      "name": "Free",
      "code": "FREE",
      "priority": 100,
      "price": null,
      "options": [
        {
          "code": "MAX_GROUP",
          "value": 5
        }
      ]
    }
  ]
}
```

## Интеграция с другими контекстами

### Account Context

**События:**
- `UserPermissionsUpdatedEvent` → `UserPermissionsUpdatedHandler` в Account Context

**Результат:**
- Обновление кэша прав в поле `permissions` пользователя

## База данных

Таблицы:
- `billing_tariff_plans` - Тарифные планы
- `billing_tariff_options` - Опции тарифов
- `billing_tariff_plan_options` - Связь планов и опций
- `billing_subscriptions` - Подписки пользователей

## Связанные документы

- [Тарифы](tariffs.md)
- [Подписки](subscriptions.md)
- [Система прав](permissions.md)
- [Account Context](../account/overview.md)
- [Shared Context - PermissionsTrait](../shared/permissions.md)
