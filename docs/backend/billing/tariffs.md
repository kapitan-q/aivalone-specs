# Тарифные планы

## Обзор

Система поддерживает три тарифных плана с различными уровнями доступа и функциональности.

## Тарифная сетка

| Функция | **Free** | **Base** | **Premium** |
| :--- | :--- | :--- | :--- |
| **Лимит групп** | До 5 публичных | Без ограничений | Без ограничений |
| **Типы групп** | Только публичные | Публичные + Приватные | Публичные + Приватные |
| **Авторизация** | Не требуется | Требуется (TG Auth) | Требуется (TG Auth) |
| **Фильтрация** | Точное вхождение | Морфология (PHP) | **AI (Semantic/Vision)** |
| **Приоритет** | 100 | 200 | 300 |

## Структура тарифа

### TariffPlan

**Поля:**
- `id` - Уникальный идентификатор
- `name` - Название тарифа (например, "Premium")
- `code` - Код тарифа (например, `PREMIUM_MONTH`)
- `priority` - Приоритет тарифа (чем выше число, тем выше приоритет)
- `description` - Описание тарифа
- `price` - Цена (может быть `null` для бесплатного тарифа)

### TariffOption

**Поля:**
- `id` - Уникальный идентификатор
- `name` - Название опции (например, "Лимит групп")
- `code` - Код опции (например, `MAX_GROUP`)
- `value` - Значение опции (например, `5`)

### Связь TariffPlanOption

**Ограничения:**
- В связке `TariffPlan` <-> `TariffOption` код опции должен быть **уникальным**
- Один тариф не может иметь две разные опции с одним кодом
- Обеспечивается на уровне БД через `UniqueConstraint`

## Опции тарифов

### Free (Приоритет: 100)

**Опции:**
- `MAX_GROUP`: `5` - Максимальное количество групп

### Base (Приоритет: 200)

**Опции:**
- `MAX_GROUP`: `без ограничений` (или большое число)
- `CAN_USE_PRIVATE_GROUPS`: `true` - Доступ к приватным группам
- `CAN_USE_MORPHOLOGY`: `true` - Морфологическая фильтрация

### Premium (Приоритет: 300)

**Опции:**
- `MAX_GROUP`: `без ограничений` (или большое число)
- `CAN_USE_PRIVATE_GROUPS`: `true` - Доступ к приватным группам
- `CAN_USE_MORPHOLOGY`: `true` - Морфологическая фильтрация
- `CAN_USE_AI`: `true` - Доступ к AI фильтрации

## Приоритеты и наслоение

При наслоении подписок (например, Free + Base) опции с высшим приоритетом перезаписывают низшие.

**Пример:**
- Пользователь имеет активные подписки: Free (priority 100) + Base (priority 200)
- Free предоставляет: `MAX_GROUP: 5`
- Base предоставляет: `MAX_GROUP: без ограничений`, `CAN_USE_PRIVATE_GROUPS: true`
- Итоговый результат: `MAX_GROUP: без ограничений`, `CAN_USE_PRIVATE_GROUPS: true` (Base перезаписывает Free)

## DataFixtures

Тарифная сетка создается через DataFixtures при инициализации базы данных.

**Файл:** `src/Context/Billing/Infrastructure/DataFixtures/TariffPlanFixtures.php`

## API

### GET /api/billing/tariffs

Получение списка всех тарифных планов с опциями.

**Ответ:**
```json
{
  "tariffs": [
    {
      "id": 1,
      "name": "Free",
      "code": "FREE",
      "priority": 100,
      "price": null,
      "description": "Бесплатный тариф",
      "options": [
        {
          "code": "MAX_GROUP",
          "name": "Лимит групп",
          "value": 5
        }
      ]
    },
    {
      "id": 2,
      "name": "Base",
      "code": "BASE_MONTH",
      "priority": 200,
      "price": 299,
      "description": "Базовый тариф",
      "options": [
        {
          "code": "MAX_GROUP",
          "name": "Лимит групп",
          "value": null
        },
        {
          "code": "CAN_USE_PRIVATE_GROUPS",
          "name": "Доступ к приватным группам",
          "value": true
        },
        {
          "code": "CAN_USE_MORPHOLOGY",
          "name": "Морфологическая фильтрация",
          "value": true
        }
      ]
    }
  ]
}
```

## Связанные документы

- [Обзор Billing Context](overview.md)
- [Подписки](subscriptions.md)
- [Система прав](permissions.md)
